<% layout("layouts/boilerplate") %>

<div class="container mt-4">


  <div class="row g-5 align-items-start mb-5">

    <!-- LEFT: IMAGE SLIDER -->
    <div class="col-12 col-md-6">
      <% if (material.images && material.images.length > 0) { %>
        <div class="slider" data-index="0">

          <% material.images.forEach((img, i) => { %>
            <div class="material-img-wrapper <%= i === 0 ? 'active' : '' %>">
              <img src="<%= img.url %>" />
            </div>
          <% }) %>

          <% if (material.images.length > 1) { %>
            <button class="slider-btn prev" onclick="slide(this, -1)">‚Äπ</button>
            <button class="slider-btn next" onclick="slide(this, 1)">‚Ä∫</button>
          <% } %>

        </div>
      <% } %>
    </div>

    <!-- RIGHT: DETAILS -->
    <div class="col-12 col-md-6">

      <h2 class="mb-1"><%= material.title %></h2>

      <!-- RATING SUMMARY -->
      <% if (material.reviews && material.reviews.length > 0) { %>
        <p class="text-muted mb-2">
          ‚≠ê
          <strong>
            <%= (
              material.reviews.reduce((s, r) => s + r.rating, 0) /
              material.reviews.length
            ).toFixed(1) %>
          </strong>
          ¬∑ <%= material.reviews.length %> reviews
        </p>
      <% } else { %>
        <p class="text-muted mb-2">No ratings yet</p>
      <% } %>

      <!-- DESCRIPTION -->
      <div id="description-box">

        <p id="desc-en" class="material-desc collapsed">
          <%= material.description.en %>
        </p>

        <% if (material.description.te) { %>
          <p id="desc-te" class="material-desc telugu collapsed">
            <%= material.description.te %>
          </p>
        <% } %>

        <button
          id="readMoreBtn"
          class="btn btn-link p-0 mt-1"
          onclick="toggleDescription()">
          Read more
        </button>

      </div>

      <!-- WRITE REVIEW (CUSTOMER) -->
      <% if (currentUser && currentUser.role !== "admin") { %>
        <button
          class="btn btn-outline-dark btn-sm mt-3"
          data-bs-toggle="modal"
          data-bs-target="#reviewModal">
          ‚úçÔ∏è Write a Review
        </button>
      <% } else if (!currentUser) { %>
        <p class="text-muted mt-3">Login to write a review.</p>
      <% } %>

      <!-- ADMIN CONTROLS -->
      <% if (currentUser && currentUser.role === "admin") { %>
        <hr class="my-4">
        <div class="d-flex gap-2">
          <a
            href="/materials/<%= material._id %>/edit"
            class="btn btn-outline-primary btn-sm">
            ‚úèÔ∏è Edit Material
          </a>

          <button
            class="btn btn-outline-danger btn-sm"
            data-bs-toggle="modal"
            data-bs-target="#deleteMaterialModal">
            üóë Delete
          </button>
        </div>
      <% } %>

    </div>
  </div>

  <!-- CUSTOMER REVIEWS -->

  <div class="reviews-section">

    <h4 class="reviews-title">Customer Reviews</h4>

    <% if (!material.reviews || material.reviews.length === 0) { %>
      <p class="no-reviews">No reviews yet.</p>
    <% } %>

    <% material.reviews?.forEach(r => { %>
      <div class="review-card">

        <div class="review-header">
          <span class="review-user">
            <%= r.author?.username || "User" %>
          </span>

          <span class="review-rating">
            ‚≠ê <%= r.rating %>/5
          </span>
        </div>

        <p class="review-comment">
          <%= r.comment || "" %>
        </p>

      </div>
    <% }) %>

  </div>

  <div class="mt-4">
    <a href="/materials" class="btn btn-outline-secondary btn-sm">
      ‚Üê Back to Materials
    </a>
  </div>

</div>

<!--REVIEW MODAL -->
<div class="modal fade" id="reviewModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <form method="POST" action="/materials/<%= material._id %>/reviews">

        <div class="modal-header">
          <h5 class="modal-title">Write a Review</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">

          <div class="mb-3">
            <label class="form-label fw-semibold">Rating</label>

            <div class="rating-stars">
              <% for (let i = 5; i >= 1; i--) { %>
                <input
                  type="radio"
                  id="material-star<%= i %>"
                  name="rating"
                  value="<%= i %>"
                  required>
                <label for="material-star<%= i %>">‚òÖ</label>
              <% } %>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold">Your Review</label>
            <textarea
              name="commentEn"
              class="form-control"
              rows="3"
              placeholder="Share your experience..."
              required></textarea>
          </div>

        </div>

        <div class="modal-footer">
          <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">
            Cancel
          </button>
          <button class="btn btn-dark btn-sm">
            Submit Review
          </button>
        </div>

      </form>

    </div>
  </div>
</div>

<!--DELETE MODAL-->
<div class="modal fade" id="deleteMaterialModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Delete Material</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        Are you sure you want to delete this material?
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
          Cancel
        </button>
        <form action="/materials/<%= material._id %>?_method=DELETE" method="POST">
          <button class="btn btn-danger btn-sm">Yes, Delete</button>
        </form>
      </div>

    </div>
  </div>
</div>

<!-- ================= STYLES ================= -->
<style>
  .material-img-wrapper {
    display: none;
    width: 100%;
    height: 380px;
    background: #f5f5f5;
    border-radius: 16px;
    overflow: hidden;
  }

  .material-img-wrapper.active {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .material-img-wrapper img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }

  .material-desc.collapsed {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  
  .rating-stars {
    display: flex;
    flex-direction: row-reverse;
    justify-content: flex-end;
    gap: 6px;
  }

  .rating-stars input { display: none; }

  .rating-stars label {
    font-size: 1.8rem;
    color: #ddd;
    cursor: pointer;
  }

  .rating-stars label:hover,
  .rating-stars label:hover ~ label,
  .rating-stars input:checked ~ label {
    color: #f5b301;
  }

 
  .reviews-section {
    max-width: 760px;
  }

  .reviews-title {
    font-size: 1.45rem;
    font-weight: 600;
    margin-bottom: 1.4rem;
  }

  .review-card {
    background: #fff;
    border-radius: 16px;
    padding: 1.2rem 1.4rem;
    margin-bottom: 1.2rem;
    border: 1px solid #e6e8ec;
    box-shadow: 0 4px 14px rgba(0,0,0,0.04);
  }

  .review-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.6rem;
  }

  .review-user {
    font-weight: 600;
    font-size: 0.95rem;
  }

  .review-rating {
    font-size: 0.9rem;
    background: #fff7e6;
    padding: 0.25rem 0.55rem;
    border-radius: 20px;
    color: #f4b400;
  }

  .review-comment {
    margin: 0;
    font-size: 0.95rem;
    line-height: 1.6;
    color: #555;
  }

  .no-reviews {
    font-style: italic;
    color: #777;
  }
</style>

<script>
  function slide(btn, direction) {
    const slider = btn.parentElement;
    const images = slider.querySelectorAll(".material-img-wrapper");
    let index = parseInt(slider.dataset.index);
    images[index].classList.remove("active");
    index = (index + direction + images.length) % images.length;
    images[index].classList.add("active");
    slider.dataset.index = index;
  }

  function toggleDescription() {
    document.getElementById("desc-en").classList.toggle("collapsed");
    document.getElementById("desc-te")?.classList.toggle("collapsed");

    const btn = document.getElementById("readMoreBtn");
    btn.innerText =
      btn.innerText === "Read more" ? "Read less" : "Read more";
  }
</script>
